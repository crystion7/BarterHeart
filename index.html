<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anoma | Intent Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="particles-js"></div>
    <div class="page-content">
        <header>
            <div class="nav-container">
                <div class="logo">
                    <img src="anoma_logo.jpg" alt="Anoma Logo">
                    <h1>Anoma Intent dApp</h1>
                </div>
                <nav>
                    <a href="index.html" class="active">Dashboard</a>
                    <a href="actions.html">Submit Intent</a>
                </nav>
            </div>
        </header>

        <main class="container">
            <div class="dashboard-grid">
                <div class="dashboard-column">
                    <div class="widget-card">
                        <h3>Cause Progress Milestones</h3>
                        <div id="progress-bars"></div>
                    </div>

                    <div class="widget-card">
                        <h3>üèÜ Top Donors</h3>
                        <div id="leaderboard"></div>
                    </div>
                </div>

                <div class="dashboard-column">
                    <div class="widget-card">
                        <h3>Your Anonymous Status</h3>
                        <div id="user-status"></div>
                    </div>

                     <div class="widget-card">
                        <h3>Your Badges</h3>
                        <div id="badges"></div>
                    </div>

                    <div class="widget-card full-height">
                        <div class="feed-header">
                           <h3>üìú Live Intent Feed</h3>
                           <button onclick="clearFeed()" class="button-secondary button-small">Clear All Data</button>
                        </div>
                        <div id="intents" class="intent-feed-area"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="app.js"></script>
    <script>
        // --- Central State Management & Goal Definitions ---
        const MILESTONE_GOALS = [
            { id: 'env_1', title: 'Fund Environmental Research Paper', target: 500, cause: 'Environmental Fund' },
            { id: 'edu_1', title: 'Sponsor 10 Student Scholarships', target: 2500, cause: 'Education' },
            { id: 'com_1', title: 'Upgrade Community Server', target: 1000, cause: 'Community Treasury' },
            { id: 'env_2', title: 'Organize Local River Cleanup', target: 1500, cause: 'Environmental Fund' },
            { id: 'edu_2', title: 'Buy 500 Textbooks for Schools', target: 4000, cause: 'Education' },
            { id: 'com_2', title: 'Host a Developer Workshop', target: 2000, cause: 'Community Treasury' }
        ];

        function getAppState() {
            const defaultState = {
                intents: [],
                donationTotals: {},
                leaderboard: [],
                userProfile: { id: null, alias: null, donatedTo: [], totalDonated: 0, swapsMade: 0, votesCast: 0 }
            };
            return JSON.parse(localStorage.getItem('anomaAppState')) || defaultState;
        }

        function calculateUserTitle(profile) {
            const score = (profile.totalDonated / 50) + (profile.swapsMade * 20) + (profile.votesCast * 5);
            if (score > 1000) return "Anonymous Leviathan";
            if (score > 500) return "Anonymous Oracle";
            if (score > 200) return "Anonymous Visionary";
            if (score > 50) return "Anonymous Contributor";
            if (score > 10) return "Anonymous Initiate";
            return "Anonymous Tadpole";
        }

        // --- UI Display Functions ---
        function displayProgress() {
            const container = document.getElementById('progress-bars');
            const state = getAppState();
            container.innerHTML = '';
            
            let remainingFunds = { ...(state.donationTotals || {}) };

            MILESTONE_GOALS.forEach(goal => {
                const causeTotal = remainingFunds[goal.cause] || 0;
                let progressOnThisGoal = 0;

                if (causeTotal > 0) {
                    progressOnThisGoal = Math.min(causeTotal, goal.target);
                    remainingFunds[goal.cause] -= progressOnThisGoal;
                }

                const percentage = (progressOnThisGoal / goal.target) * 100;
                const barHtml = `
                    <div class="progress-item">
                        <div class="progress-labels">
                            <span>${goal.title}</span>
                            <span>${Math.floor(progressOnThisGoal)} / ${goal.target} Tokens</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${percentage}%;"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += barHtml;
            });
        }
        
        function displayUserStatus() {
            const container = document.getElementById('user-status');
            const profile = getAppState().userProfile;
            const title = calculateUserTitle(profile);

            container.innerHTML = `
                <div class="user-title">${title}</div>
                <div class="user-alias">Alias: <strong>${profile.alias || 'Not Set'}</strong></div>
                <div class="user-stats">
                    <span>Donated: <strong>${profile.totalDonated}</strong> Tokens</span>
                    <span>Swaps Made: <strong>${profile.swapsMade}</strong></span>
                    <span>Votes Cast: <strong>${profile.votesCast}</strong></span>
                </div>
            `;
        }

        function displayLeaderboard() {
            const container = document.getElementById('leaderboard');
            const state = getAppState();
            container.innerHTML = '';
            if (state.leaderboard.length === 0) {
                container.innerHTML = '<p class="placeholder">No donations yet!</p>'; return;
            }
            const list = document.createElement('ol');
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            state.leaderboard.slice(0, 5).forEach((donor, index) => {
                const item = document.createElement('li');
                if (index < 3) item.classList.add(`rank-${index + 1}`);
                item.innerHTML = `<span>${medals[index] || ''} ${donor.alias}</span> <strong>${donor.totalDonated} Tokens</strong>`;
                list.appendChild(item);
            });
            container.appendChild(list);
        }

        function displayBadges() {
            const container = document.getElementById('badges');
            const donatedTo = getAppState().userProfile.donatedTo || [];
             const badgesMap = {
                "Environmental Fund": 'üå± Environment Guardian',
                "Education": 'üéì Education Ally',
                "Community Treasury": 'üèõÔ∏è Community Pillar'
            };
            container.innerHTML = '';
            if (donatedTo.length === 0) {
                container.innerHTML = '<p class="placeholder">No badges yet.</p>';
                return;
            }
            donatedTo.forEach(cause => {
                if (badgesMap[cause]) {
                    const badge = document.createElement('div');
                    badge.className = 'badge';
                    badge.textContent = badgesMap[cause];
                    container.appendChild(badge);
                }
            });
        }
        
        function displayIntents() {
            const container = document.getElementById('intents');
            const state = getAppState();
            container.innerHTML = '';
            if (state.intents.length === 0) {
                container.innerHTML = '<p class="placeholder">No intents submitted yet.</p>';
            } else {
                state.intents.forEach(intentData => {
                    const intent = document.createElement('div');
                    intent.className = 'intent';
                    
                    if (intentData.type === 'swap') {
                        intent.innerHTML = `<span>SWAP:</span> Trade <strong>${intentData.myNFT}</strong> for <strong>${intentData.desiredNFT}</strong>`;
                    } else if (intentData.type === 'donation') {
                        intent.innerHTML = `<span class="intent-author">${intentData.donorAlias}:</span> pledged <strong>${intentData.amount}</strong> tokens to <strong>${intentData.cause}</strong>`;
                    } else if (intentData.type === 'match') {
                        intent.classList.add('match');
                        intent.innerHTML = `<span>‚úÖ MATCH:</span> <strong>${intentData.item1}</strong> swapped for <strong>${intentData.item2}</strong>!`;
                    } else if (intentData.type === 'vote') {
                        intent.classList.add('vote');
                        intent.innerHTML = `<span class="intent-author">${intentData.voterAlias}:</span> supports the proposal: <strong>"${intentData.proposal}"</strong>`;
                    }
                    container.appendChild(intent);
                });
            }
        }
        
        function clearFeed() {
            if(confirm('Are you sure you want to clear ALL application data, including your anonymous profile?')){
                localStorage.removeItem('anomaAppState');
                runDashboard();
            }
        }
        
        function runDashboard() {
            displayUserStatus();
            displayProgress();
            displayLeaderboard();
            displayBadges();
            displayIntents();
        }

        // --- ROBUST PAGE LOAD & UPDATE LOGIC ---

        // 1. This handles live updates when the dashboard is open in another tab.
        window.addEventListener('storage', function(event) {
          if (event.key === 'anomaAppState') {
            runDashboard();
          }
        });

        // 2. This handles updates when navigating back to the page.
        // It replaces the less reliable 'window.onload'.
        window.addEventListener('pageshow', function(event) {
            // event.persisted is true if the page was restored from the back-forward cache.
            // We want to re-run the dashboard in all cases to ensure data is fresh.
            runDashboard();
        });

    </script>
</body>
</html>