<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anoma | Submit Intent</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="toast-container"></div>

    <div id="particles-js"></div>
    <div class="page-content">
        <header>
            <div class="nav-container">
                <div class="logo">
                    <img src="anoma_logo.jpg" alt="Anoma Logo">
                    <h1>Anoma Intent dApp</h1>
                </div>
                <nav>
                    <a href="index.html">Dashboard</a>
                    <a href="actions.html" class="active">Submit Intent</a>
                </nav>
            </div>
        </header>

        <main class="container">
            <div class="actions-grid">
                <div class="card interactive-card">
                    <h3>üîÑ NFT Barter Swap</h3>
                    <label for="myNFT">Your NFT:</label>
                    <input type="text" id="myNFT" placeholder="e.g. Shrimper #123">
                    <label for="desiredNFT">Desired NFT:</label>
                    <input type="text" id="desiredNFT" placeholder="e.g. CoolCat #77">
                    <div id="swap-preview" class="swap-preview-message"></div>
                    <button onclick="addSwapIntent(this)">Submit Swap Intent</button>
                </div>
                <div class="card interactive-card">
                    <h3>ü§ù Anonymous Donation</h3>
                    <label for="amount">Donation Amount (Tokens):</label>
                    <input type="number" id="amount" placeholder="e.g. 50">
                    <label for="cause">Cause:</label>
                    <select id="cause">
                        <option value="Community Treasury">Community Treasury</option>
                        <option value="Environmental Fund">Environmental Fund</option>
                        <option value="Education">Education</option>
                    </select>
                    <button onclick="addDonationIntent(this)">Donate Anonymously</button>
                </div>
                <div class="card interactive-card">
                    <h3>üó≥Ô∏è Community Voting</h3>
                    <label for="proposal">Select a Proposal to Support:</label>
                     <select id="proposal">
                        <option value="Build a digital community park">Build a digital community park</option>
                        <option value="Fund a new developer grant">Fund a new developer grant</option>
                        <option value="Host a virtual hackathon">Host a virtual hackathon</option>
                    </select>
                    <button onclick="addVoteIntent(this)">Cast Your Vote</button>
                </div>
            </div>
        </main>
    </div>
    
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="app.js"></script>
    <script>
        // --- State Management Logic ---
        function getAppState() {
            const defaultState = {
                intents: [], donationTotals: {}, leaderboard: [],
                userProfile: { id: null, alias: null, donatedTo: [], totalDonated: 0, swapsMade: 0, votesCast: 0 }
            };
            let state = JSON.parse(localStorage.getItem('anomaAppState')) || defaultState;
            if (!state.userProfile.id) {
                state.userProfile = {
                    id: 'user_' + Math.random().toString(36).substr(2, 9),
                    alias: ["Anonymous Whale", "Anonymous Shrimp", "Anonymous Cat", "Anonymous Explorer"][Math.floor(Math.random() * 4)],
                    donatedTo: [], totalDonated: 0, swapsMade: 0, votesCast: 0
                };
                saveAppState(state);
            }
            return state;
        }
        function saveAppState(state) { localStorage.setItem('anomaAppState', JSON.stringify(state)); }

        // --- Toast Notification System ---
        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }

        // --- Button Animation ---
        function animateButton(button, originalText) {
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Submitting...';
            button.classList.add('loading');
            return new Promise(resolve => {
                setTimeout(() => {
                    button.classList.remove('loading');
                    button.classList.add('success');
                    button.innerHTML = 'Success ‚úì';
                    setTimeout(() => {
                        button.classList.remove('success');
                        button.innerHTML = originalText;
                        button.disabled = false;
                        resolve();
                    }, 1500);
                }, 600);
            });
        }

        // --- Main Feature Logic (Corrected and Complete) ---
        async function addSwapIntent(button) {
            const originalText = button.innerHTML;
            const myNFT = document.getElementById('myNFT').value.trim();
            const desiredNFT = document.getElementById('desiredNFT').value.trim();
            if (!myNFT || !desiredNFT) { return alert('Please fill out both NFT fields.'); }
            
            await animateButton(button, originalText);
            
            let state = getAppState();
            const matchIndex = state.intents.findIndex(i => i.type === 'swap' && i.myNFT === desiredNFT && i.desiredNFT === myNFT);
            if (matchIndex > -1) {
                state.intents.splice(matchIndex, 1);
                state.intents.unshift({ type: 'match', item1: myNFT, item2: desiredNFT });
                state.userProfile.swapsMade += 1;
                showToast('‚ú® Match Found & Swap Completed!');
            } else {
                state.intents.unshift({ type: 'swap', myNFT, desiredNFT });
                showToast('Swap intent submitted!');
            }
            saveAppState(state);
            document.getElementById('myNFT').value = '';
            document.getElementById('desiredNFT').value = '';
            checkSwapPreview();
        }

        async function addDonationIntent(button) {
            const originalText = button.innerHTML;
            const amount = parseFloat(document.getElementById('amount').value);
            const cause = document.getElementById('cause').value;
            if (!amount || amount <= 0) { return alert('Please enter a valid amount.'); }

            await animateButton(button, originalText);

            let state = getAppState();
            const user = state.userProfile;

            state.intents.unshift({ type: 'donation', amount, cause, donorAlias: user.alias, donorId: user.id });
            state.donationTotals[cause] = (state.donationTotals[cause] || 0) + amount;
            if (!user.donatedTo.includes(cause)) { user.donatedTo.push(cause); }
            user.totalDonated += amount;

            let userOnBoard = state.leaderboard.find(d => d.alias === user.alias);
            if (userOnBoard) { userOnBoard.totalDonated += amount; } 
            else { state.leaderboard.push({ alias: user.alias, totalDonated: amount }); }
            state.leaderboard.sort((a, b) => b.totalDonated - a.totalDonated);

            saveAppState(state);
            showToast('Donation recorded. Thank you!');
            document.getElementById('amount').value = '';
        }

        async function addVoteIntent(button) {
            const originalText = button.innerHTML;
            const proposal = document.getElementById('proposal').value;
            let state = getAppState();
            const user = state.userProfile;

            const hasVoted = state.intents.some(i => i.type === 'vote' && i.voterId === user.id && i.proposal === proposal);
            if (hasVoted) {
                showToast(`You have already voted for this proposal.`);
                return; 
            }

            await animateButton(button, originalText);

            state.intents.unshift({ type: 'vote', proposal, voterAlias: user.alias, voterId: user.id });
            state.userProfile.votesCast += 1;
            saveAppState(state);
            showToast('Your vote has been cast!');
        }

        function checkSwapPreview() {
            const myNFT = document.getElementById('myNFT').value.trim();
            const desiredNFT = document.getElementById('desiredNFT').value.trim();
            const previewEl = document.getElementById('swap-preview');
            if (!myNFT || !desiredNFT) { previewEl.style.display = 'none'; return; }
            const state = getAppState();
            const isMatch = state.intents.some(i => i.type === 'swap' && i.myNFT === desiredNFT && i.desiredNFT === myNFT);
            if (isMatch) {
                previewEl.textContent = 'üî• A direct match for this swap is available!';
                previewEl.style.display = 'block';
            } else { previewEl.style.display = 'none'; }
        }

        // --- Event Listeners ---
        document.getElementById('myNFT').addEventListener('input', checkSwapPreview);
        document.getElementById('desiredNFT').addEventListener('input', checkSwapPreview);
        window.onload = getAppState;
    </script>
</body>
</html>